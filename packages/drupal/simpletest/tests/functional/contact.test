<?php
// $Id: contact.test,v 1.2 2008/03/16 23:30:55 boombatower Exp $

class ContactModuleTestCase extends DrupalTestCase {
  function get_info() {
    return array(
      'name' => t('Contact functionality'),
      'description' => t('Test site-wide contact form and personal contact form functionality.'),
      'group' => t('Contact Tests'),
    );
  }

  /**
   * Configure environment.
   */
  function setUp() {
    parent::setUp();

    $this->drupalModuleEnable('contact');
  }

  /**
   * Test configuration options and site-wide contact form.
   */
  function test_site_wide_contact() {    
    // Create and login administative user.
    $admin_user = $this->drupalCreateUserRolePerm(array('administer site-wide contact form', 'administer permissions'));
    $this->drupalLoginUser($admin_user);

    // Set settings.
    $edit = array();
    $edit['contact_form_information'] = $this->randomName(100);
    $edit['contact_hourly_threshold'] = 3;
    $edit['contact_default_status'] = TRUE;
    $this->drupalPost('admin/build/contact/settings', $edit, 'Save configuration');
    $this->assertText(t('The configuration options have been saved.'), 'Setting successfully saved.');

    $this->reload_variables();

    // Delete old categories to ensure that new categories are used.
    $this->delete_categories();

    // Add categories.
    // Test invalid recipients.
    $invalid_recipients = array('invalid', 'invalid@', 'invalid@site', 'invalid@site.', '@site.', '@site.com');
    foreach ($invalid_recipients as $invalid_recipient) {
      $this->add_category($this->randomName(16), $invalid_recipient, '', FALSE);
      $this->assertWantedRaw(t('%recipient is an invalid e-mail address.', array('%recipient' => $invalid_recipient)), 'Caught invalid recipient ('. $invalid_recipient .').');
    }

    // Create valid categories.
    $recipients = array('simpletest@test.com', 'simpletest2@test.com', 'simpletest3@test.com');
    $this->add_category($category = $this->randomName(16), implode(',', array($recipients[0])), '', TRUE);
    $this->assertWantedRaw(t('Category %category has been added.', array('%category' => $category)), 'Category successfully added.');

    $this->add_category($category = $this->randomName(16), implode(',', array($recipients[0], $recipients[1])), '', FALSE);
    $this->assertWantedRaw(t('Category %category has been added.', array('%category' => $category)), 'Category successfully added.');

    $this->add_category($category = $this->randomName(16), implode(',', array($recipients[0], $recipients[1], $recipients[2])), '', FALSE);
    $this->assertWantedRaw(t('Category %category has been added.', array('%category' => $category)), 'Category successfully added.');

    // Clear food table in preparation for flood test and allow other checks to complete.
    $this->assertTrue(db_query('DELETE FROM {flood}'), 'Flood table emptied.');

    // Check to see that anonymous user cannot see contact page without permission.
    $this->set_permission('anonymous user', array('access site-wide contact form' => FALSE));
    $this->drupalGet('logout');

    $this->drupalGet('contact');
    $this->assertResponse(array(403), 'Access denied to anonymous user without permission.');

    // Give anonymous user permission and see that page is viewable.
    $this->drupalLoginUser($admin_user);
    $this->set_permission('anonymous user', array('access site-wide contact form' => TRUE));
    $this->drupalGet('logout');

    $this->drupalGet('contact');
    $this->assertResponse(array(200), 'Access granted to anonymous user with permission.');

    // Check that "Additional information" is displayed on the page.
    $this->assertText($edit['contact_form_information'], 'Contact information displayed.');

    // Submit contact form with invalid values.
    $categories = $this->get_categories();
    $this->submit_contact('', $recipients[0], $this->randomName(16), $categories[0], $this->randomName(64));
    $this->assertText(t('Your name field is required.'), 'Name required.');

    $this->submit_contact($this->randomName(16), '', $this->randomName(16), $categories[0], $this->randomName(64));
    $this->assertText(t('Your e-mail address field is required.'), 'E-mail required.');

    $this->submit_contact($this->randomName(16), $invalid_recipients[0], $this->randomName(16), $categories[0], $this->randomName(64));
    $this->assertText(t('You must enter a valid e-mail address.'), 'Valid e-mail required.');

    $this->submit_contact($this->randomName(16), $recipients[0], '', $categories[0], $this->randomName(64));
    $this->assertText(t('Subject field is required.'), 'Subject required.');

    $this->submit_contact($this->randomName(16), $recipients[0], $this->randomName(16), $categories[0], '');
    $this->assertText(t('Message field is required.'), 'Message required.');

    // Submit contact form with correct values and check flood interval.
    for ($i = 0; $i < $edit['contact_hourly_threshold']; $i++) {
      $this->submit_contact($this->randomName(16), $recipients[0], $this->randomName(16), $categories[0], $this->randomName(64));
      $this->assertText(t('Your message has been sent.'), 'Message sent.');
    }
    // Submit contact form one over limit.
    $this->drupalGet('contact');
    $this->assertWantedRaw(t('You cannot send more than %number messages per hour. Please try again later.', array('%number' => $edit['contact_hourly_threshold'])), 'Message threshold reached.');

    // Delete created categories.
    $this->drupalLoginUser($admin_user);
    $this->delete_categories();
  }

  /**
   * Test personal contact form.
   */
  function atest_personal_contact() {
    $admin_user = $this->drupalCreateUserRolePerm(array('administer site-wide contact form'));
    $this->drupalLoginUser($admin_user);

    // Enable the personal contact form.
    $edit = array();
    $edit['contact_default_status'] = TRUE;
    $this->drupalPost('admin/build/contact/settings', $edit, 'Save configuration');
    $this->assertText(t('The configuration options have been saved.'), 'Setting successfully saved.');

    // Reload variables.
    $this->drupalGet('logout');
    $this->reload_variables();

    // Create web users and attempt to use personal contact forms with default set to true.
    $web_user1 = $this->drupalCreateUserRolePerm(array());
    $web_user2 = $this->drupalCreateUserRolePerm(array());

    $this->drupalLoginUser($web_user1);

    $this->drupalGet('user/'. $web_user2->uid .'/contact');
    $this->assertResponse(array(200), 'Access to personal contact form granted.');

    $edit = array();
    $edit['subject'] = $this->randomName(16);
    $edit['message'] = $this->randomName(64);
    $this->drupalPost(NULL, $edit, 'Send e-mail');
    $this->assertText(t('The message has been sent.'), 'Message sent.');

    $this->drupalGet('logout');

    $this->drupalLoginUser($admin_user);

    // Disable the personal contact form.
    $edit = array();
    $edit['contact_default_status'] = FALSE;
    $this->drupalPost('admin/build/contact/settings', $edit, 'Save configuration');
    $this->assertText(t('The configuration options have been saved.'), 'Setting successfully saved.');

    // Reload variables.
    $this->drupalGet('logout');
    $this->reload_variables();

    // Create web users and attempt to use personal contact forms with default set to false.
    $web_user3 = $this->drupalCreateUserRolePerm(array());
    $web_user4 = $this->drupalCreateUserRolePerm(array());

    $this->drupalLoginUser($web_user3);

    $this->drupalGet('user/'. $web_user4->uid .'/contact');
    $this->assertResponse(array(403), 'Access to personal contact form denied.');
  }

  /**
   * Add a category.
   *
   * @param string $category Name of category.
   * @param string $recipients List of recipient e-mail addresses.
   * @param string $reply Auto-reply text.
   * @param boolean $selected Defautly selected.
   */
  function add_category($category, $recipients, $reply, $selected) {
    $edit = array();
    $edit['category'] = $category;
    $edit['recipients'] = $recipients;
    $edit['reply'] = $reply;
    $edit['selected'] = ($selected ? '1' : '0');
    $this->drupalPost('admin/build/contact/add', $edit, 'Save');
  }

  /**
   * Submit contact form.
   *
   * @param string $name Name.
   * @param string $mail E-mail address.
   * @param string $subject Subject.
   * @param integer $cid Category id.
   * @param string $message Message.
   */
  function submit_contact($name, $mail, $subject, $cid, $message) {
    $edit = array();
    $edit['name'] = $name;
    $edit['mail'] = $mail;
    $edit['subject'] = $subject;
    $edit['cid'] = $cid;
    $edit['message'] = $message;
    $this->drupalPost('contact', $edit, 'Send e-mail');
  }

  /**
   * Delete all categories.
   */
  function delete_categories() {
    $categories = $this->get_categories();
    foreach ($categories as $category) {
      $category_name = db_result(db_query('SELECT category FROM {contact} WHERE cid = %d', array($category)));
      $this->drupalPost('admin/build/contact/delete/'. $category, array(), 'Delete');
      $this->assertWantedRaw(t('Category %category has been deleted.', array('%category' => $category_name)), 'Category deleted sucessfully.');
    }
  }

  /**
   * Get list category ids.
   *
   * @return array Category ids.
   */
  function get_categories() {
    $result = db_query('SELECT cid FROM {contact}');
    $categories = array();
    while ($category = db_result($result)) {
      $categories[] = $category;
    }
    return $categories;
  }

  /**
   * Set permission.
   *
   * @param string $role User role to set permissions for.
   * @param array $permissions Key-value array of permissions to set.
   */
  function set_permission($role, $permissions) {
    // Get role id (rid) for specified role.
    $rid = db_result(db_query("SELECT rid FROM {role} WHERE name = '%s'", array($role)));
    if ($rid === FALSE) {
      $this->fail(' [permission] Role "'. $role .'" not found.');
    }

    // Create edit array from permission.
    $edit = array();
    foreach ($permissions as $name => $value) {
      $edit[$rid .'['. $name .']'] = $value;
    }

    $this->drupalPost('admin/user/permissions', $edit, 'Save permissions');
    $this->assertText(t('The changes have been saved.'), ' [permission] Saved changes.');
  }

  /**
   * Reload variables table.
   */
  function reload_variables() {
    global $conf;

    cache_clear_all('variables', 'cache');
    $conf = variable_init();
  }
}
