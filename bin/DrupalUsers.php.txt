<?php

require_once '../modules/config.inc.php';

require_once 'DB.php';
require_once 'CRM/Core/Config.php';
require_once 'CRM/Core/BAO/UFMatch.php';

function user_access( $string ) {
    return true;
}

function module_list( ) { 
    return array( ); 
} 
 
$config =& CRM_Core_Config::singleton( );

/**
 * Update the next line with the correct Drupal database user, password, db_server and db name
 * for your Drupal installation.
 */
$dsn_drupal  = "mysql://drupal_db_user:drupal_db_password@db_server/drupal_db";

$db_drupal = DB::connect($dsn_drupal);
if ( DB::isError( $db_drupal ) ) {
    die( "Cannot connect to drupal db via $dsn, " . $db_drupal->getMessage( ) );
}
 
$sql   = "SELECT uid, mail FROM users where mail != ''";
$query = $db_drupal->query( $sql );

$user  = null;
$uf    = 'Drupal';

while ( $row = $query->fetchRow( DB_FETCHMODE_ASSOC ) ) {
    echo $row['mail'] . "\n";
    if ( CRM_Core_BAO_UFMatch::synchronizeUFMatch( $user, $row['uid'], $row['mail'], $uf ) ) {
        echo "Created Contact for user\n";
    }
}

$db_drupal->disconnect( );

?>
