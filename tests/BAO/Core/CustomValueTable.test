<?php

require_once 'CiviTestCase.php';
require_once 'Contact.php';
require_once 'Custom.php';

class BAO_Core_CustomValueTable extends CiviTestCase 
{
    function get_info( ) 
    {
        return array(
                     'name'        => 'Custom Value Table BAOs',
                     'description' => 'Test all Core_BAO_CustomValueTable methods.',
                     'group'       => 'CiviCRM BAO Tests',
                     );
    }
    
    function setUp( ) 
    {
        parent::setUp();
    }


    /*
     * function to test store function for country
     *
     */
    function testStoreCountry()
    {
        $params      = array();
        $contactID   = Contact::createIndividual();
        $customGroup = Custom::createGroup( $params ,'Individual' );
        $fields      = array (
                              'groupId'  => $customGroup->id,
                              'dataType' => 'Country',
                              'htmlType' => 'Select Country'
                              );
        
        $customField = Custom::createField( $params, $fields );
        
        $params = array( $customField->id => array (
                                                    'value'            => 1228,
                                                    'type'             => 'Country',
                                                    'custom_field_id'  => $customField->id,
                                                    'custom_group_id'  => $customGroup->id,
                                                    'table_name'       => 'civicrm_value_test_group_'.$customGroup->id,
                                                    'column_name'      => 'test_Country_'.$customField->id,
                                                    'file_id'          => ''
                                                     ));

        require_once 'CRM/Core/BAO/CustomValueTable.php';
        CRM_Core_BAO_CustomValueTable::store( $params, 'civicrm_contact', $contactID );
        //        $this->assertDBCompareValue('CRM_Custom_DAO_CustomValue', )
        
        Custom::deleteField( $customField );        
        Custom::deleteGroup( $customGroup );
        Contact::delete( $contactID );
    }

    /*
     * function to test store function for file
     *
     */
    function atestStoreFile()
    {
        $params      = array();
        $contactID   = Contact::createIndividual();
        $customGroup = Custom::createGroup( $params ,'Individual' );
        $fields      = array (
                              'groupId'  => $customGroup->id,
                              'dataType' => 'File',
                              'htmlType' => 'File'
                              );
        
        $customField = Custom::createField( $params, $fields );
        
        $params = array( $customField->id => array (
                                                    'value'            => 'i/contact_house.png',
                                                    'type'             => 'File',
                                                    'custom_field_id'  => $customField->id,
                                                    'custom_group_id'  => $customGroup->id,
                                                    'table_name'       => 'civicrm_value_test_group_'.$customGroup->id,
                                                    'column_name'      => 'test_File_'.$customField->id,
                                                    'file_id'          => 1
                                                     ));

        require_once 'CRM/Core/BAO/CustomValueTable.php';
        CRM_Core_BAO_CustomValueTable::store( $params, 'civicrm_contact', $contactID );
        //        $this->assertDBCompareValue('CRM_Custom_DAO_CustomValue', )
        
        Custom::deleteField( $customField );        
        Custom::deleteGroup( $customGroup );
        Contact::delete( $contactID );
    }

    /*
     * function to test store function for state province
     *
     */
    function testStoreStateProvince()
    {
        $params      = array();
        $contactID   = Contact::createIndividual();
        $customGroup = Custom::createGroup( $params ,'Individual' );
        $fields      = array (
                              'groupId'  => $customGroup->id,
                              'dataType' => 'StateProvince',
                              'htmlType' => 'Select State/Province'
                              );
        
        $customField = Custom::createField( $params, $fields );
        
        $params = array( $customField->id => array (
                                                    'value'            => 1029,
                                                    'type'             => 'StateProvince',
                                                    'custom_field_id'  => $customField->id,
                                                    'custom_group_id'  => $customGroup->id,
                                                    'table_name'       => 'civicrm_value_test_group_'.$customGroup->id,
                                                    'column_name'      => 'test_StateProvince_'.$customField->id,
                                                    'file_id'          => 1
                                                    ));

        require_once 'CRM/Core/BAO/CustomValueTable.php';
        CRM_Core_BAO_CustomValueTable::store( $params, 'civicrm_contact', $contactID );
        //        $this->assertDBCompareValue('CRM_Custom_DAO_CustomValue', )
        
        Custom::deleteField( $customField );        
        Custom::deleteGroup( $customGroup );
        Contact::delete( $contactID );
    }

    /*
     * function to test store function for date
     *
     */
    function testStoreDate()
    {
        $params      = array();
        $contactID   = Contact::createIndividual();
        $customGroup = Custom::createGroup( $params ,'Individual' );
        $fields      = array (
                              'groupId'  => $customGroup->id,
                              'dataType' => 'Date',
                              'htmlType' => 'Select Date'
                              );
        
        $customField = Custom::createField( $params, $fields );
        
        $params = array( $customField->id => array (
                                                    'value'            => '20080608000000',
                                                    'type'             => 'Date',
                                                    'custom_field_id'  => $customField->id,
                                                    'custom_group_id'  => $customGroup->id,
                                                    'table_name'       => 'civicrm_value_test_group_'.$customGroup->id,
                                                    'column_name'      => 'test_Date_'.$customField->id,
                                                    'file_id'          => ''
                                                    ));

        require_once 'CRM/Core/BAO/CustomValueTable.php';
        CRM_Core_BAO_CustomValueTable::store( $params, 'civicrm_contact', $contactID );
        //        $this->assertDBCompareValue('CRM_Custom_DAO_CustomValue', )
        
        Custom::deleteField( $customField );        
        Custom::deleteGroup( $customGroup );
        Contact::delete( $contactID );
    }

    /*
     * function to test store function for rich text editor
     *
     */
    function testStoreRichTextEditor()
    {
        $params      = array();
        $contactID   = Contact::createIndividual();
        $customGroup = Custom::createGroup( $params ,'Individual' );
        $fields      = array (
                              'groupId'  => $customGroup->id,
                              'htmlType' => 'RichTextEditor',
                              'dataType' => 'Memo'
                              );
        
        $customField = Custom::createField( $params, $fields );
        
        $params = array( $customField->id => array (
                                                    'value'            => '<p><strong>This is a <u>test</u></p>',
                                                    'type'             => 'Memo',
                                                    'custom_field_id'  => $customField->id,
                                                    'custom_group_id'  => $customGroup->id,
                                                    'table_name'       => 'civicrm_value_test_group_'.$customGroup->id,
                                                    'column_name'      => 'test_Memo_'.$customField->id,
                                                    'file_id'          => ''
                                                    ));
        
        require_once 'CRM/Core/BAO/CustomValueTable.php';
        CRM_Core_BAO_CustomValueTable::store( $params, 'civicrm_contact', $contactID );
        //        $this->assertDBCompareValue('CRM_Custom_DAO_CustomValue', )
        
        Custom::deleteField( $customField );        
        Custom::deleteGroup( $customGroup );
        Contact::delete( $contactID );
    }

    /*
     * function to test getEntityValues function for stored value
     *
     */
    function testgetEntityValues()
    {

        $params      = array();
        $contactID   = Contact::createIndividual();
        $customGroup = Custom::createGroup( $params ,'Individual' );
        $fields      = array (
                              'groupId'  => $customGroup->id,
                              'htmlType' => 'RichTextEditor',
                              'dataType' => 'Memo'
                              );
        
        $customField = Custom::createField( $params, $fields );
        
        $params = array( $customField->id => array (
                                                    'value'            => '<p><strong>This is a <u>test</u></p>',
                                                    'type'             => 'Memo',
                                                    'custom_field_id'  => $customField->id,
                                                    'custom_group_id'  => $customGroup->id,
                                                    'table_name'       => 'civicrm_value_test_group_'.$customGroup->id,
                                                    'column_name'      => 'test_Memo_'.$customField->id,
                                                    'file_id'          => ''
                                                    ));
        
        require_once 'CRM/Core/BAO/CustomValueTable.php';
        CRM_Core_BAO_CustomValueTable::store( $params, 'civicrm_contact', $contactID );
        //        $this->assertDBCompareValue('CRM_Custom_DAO_CustomValue', )

        require_once 'CRM/Core/BAO/CustomValueTable.php';
        $entityValues =  CRM_Core_BAO_CustomValueTable::getEntityValues( $contactID, 'Individual' );
              
        $this->assertEqual( $entityValues[$customField->id] ,'<p><strong>This is a <u>test</u></p>',
                            'Checking same for returned value.' );    
        Custom::deleteField( $customField );        
        Custom::deleteGroup( $customGroup );
        Contact::delete( $contactID );
    }

    function testCustomGroupMultiple( ) {
        $params      = array();
        $contactID   = Contact::createIndividual();
        $customGroup = Custom::createGroup( $params ,'Individual' );
        $fields      = array (
                              'groupId'  => $customGroup->id,
                              'dataType' => 'String',
                              'htmlType' => 'Text'
                              );
        $customField = Custom::createField( $params, $fields );

        $params = array( 'entityI'    => 102,
                         'custom_5_-1' => 'First String',
                         );
        $error = CRM_Core_BAO_CustomValueTable::setValues( $params );
        CRM_Core_Error::debug( $error );
        
        $newParams = array( 'entityID'    => $contactID,
                            'custom_5'    => 1 );
        $result = CRM_Core_BAO_CustomValueTable::getValues( $newParams );
        
        $this->assertEqual( $params['custom_5_-1'], $result['custom_5_1'] );
        $this->assertEqual( $params['entityID'], $result['entityID'] );
    }
    
}
