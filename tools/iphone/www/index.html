<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
  "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <meta name="viewport" content="width=320; user-scalable=no" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>CiviCRM</title>
<style type="text/css" media="screen">@import "iui/iui.css";</style>
<script type="text/javascript" src="phonegap.js"></script>
<script type="application/x-javascript" src="iui/iui.js"></script>
<script type="text/javascript">

		//alert("hit the start of the inline code");

    var getLocation = function() {
      var suc = function(p){
		    alert(p.latitude + " " + p.longitude);
      };
      var fail = function(){};
      navigator.geolocation.getCurrentPosition(suc,fail);
    }
    
    var beep = function(){
	    navigator.notification.beep(2);
    }
	
  	var vibrate = function(){
  	  navigator.notification.vibrate(0);
  	}
	
  	var getContact = function(){
  	  var suc = function(c){ alert("Contact 4: " + c.contacts[3].name); };
  		var fail = function(){};
  		navigator.ContactManager.get(suc, fail);
  	}

  	var loadURL = function(){
  	  var suc = function(c){ alert("Loaded URL: " + c.contacts[3].name); };
  		var fail = function(){};
		alert("hit");
  	}
  	
  	var watchAccel = function() {
  		var suc = function(a){
  			document.getElementById('x').innerHTML = roundNumber(a.x);
  			document.getElementById('y').innerHTML = roundNumber(a.y);
  			document.getElementById('z').innerHTML = roundNumber(a.z);
  		};
  		var fail = function(){};
  		var opt = {};
  		opt.frequency = 100;
  		timer = navigator.accelerometer.watchAcceleration(suc,fail,opt);
  	}
    	
    function roundNumber(num) {
      var dec = 3;
      var result = Math.round(num*Math.pow(10,dec))/Math.pow(10,dec);
      return result;
    }
    
	  var preventBehavior = function(e) { 
      e.preventDefault(); 
    };

		var mydb=false;
    initDB = function() {
      try { 
        if (!window.openDatabase) { 
			alert('not supported'); 
        } else { 
          var shortName = 'civicrm'; 
          var version = '1.0'; 
          var displayName = 'CiviCRM datastorage'; 
          var maxSize = 65536; // in bytes 
          mydb = openDatabase(shortName, version, displayName, maxSize); 
         }
      } catch(e) { 
        if (e == INVALID_STATE_ERR) { 
          alert("Invalid database version."); 
        } else { 
          alert("Unknown error "+e+"."); 
        } 
        return; 
      } 
    }

	errorHandler = function(tx,e){
		alert(e.message);
		}

    loadSettingsErrorHandler = function (transaction, e) { 
		initCiviCRMTables();
			createSetting('host','');
			createSetting('uid','');
			createSetting('pw','');
		loadSettings();
    } 
 
    nullDataHandler = function (transaction, results) { } 

    initCiviCRMTables = function() {
      try {
        mydb.transaction(
          function(transaction) {
            transaction.executeSql('CREATE TABLE civicrm_settings(k TEXT NOT NULL PRIMARY KEY, value TEXT NOT NULL DEFAULT "");', [], nullDataHandler, errorHandler); 
		});
      } catch(e) {
        return;
      }
    }
	
    settingsDataHandler=function(transaction, results) {
	
      for (var i=0; i<results.rows.length; i++) { 
        var row = results.rows.item(i); 
		window[row['k']]=row['value'];
      }
	   
			document.settingsForm.host.value = host;
			document.settingsForm.uid.value = uid;
			document.settingsForm.pw1.value = pw;
			document.settingsForm.pw2.value = pw;
	  
    }

    loadSettings = function() {
        mydb.transaction(
            function(transaction) {
               transaction.executeSql('SELECT * FROM civicrm_settings ORDER BY k',[], settingsDataHandler, loadSettingsErrorHandler);
            });
    }


    createSetting = function(key,value) {
      try {
        mydb.transaction(
            function(transaction) {
				transaction.executeSql('INSERT INTO civicrm_settings (k,value) values("'+key+'","'+value+'");',[], nullDataHandler, errorHandler);
            });
      } catch(e) {
			
			alert("an error occurred updating the settings database");
		  
      }
 
    }

    saveSetting = function(key,value) {
      try {
        mydb.transaction(
            function(transaction) {
				   transaction.executeSql('UPDATE civicrm_settings set value="'+value+'" where k="'+key+'";',[], nullDataHandler, errorHandler);
            });
      } catch(e) {
			
			alert("an error occurred updating the settings database");
		  
      }
 
    }

	function saveSettings(){

		var pw1 = document.getElementById('pw1').value;
		var pw2 = document.getElementById('pw2').value;
		if( pw1 == pw2 ){
		
			pw = pw1;
			saveSetting("pw",pw);

			window['host'] = document.getElementById('host').value;
			saveSetting("host",host);

			uid = document.getElementById('uid').value;
			saveSetting("uid",uid);

			history.back();
			
		}else{
			alert("your passwords don't match: "+pw1+" != "+pw2);
		}
	
	}

	function init(){
		document.addEventListener("touchmove", preventBehavior, false);
		initDB();
		loadSettings();
	}
		
		
</script>

  </head>
  <body onload="init()" id="stage" class="theme">

    <div class="toolbar">
        <h1 id="pageTitle"></h1>
        <a id="backButton" class="button" href="index.html"></a>
    </div>

	<ul id="home" title="CiviCRM" selected="true">
		<li><a href="#" onclick="alert(host)">Contacts</a></li>
        <li><a href="#settings" >Settings</a></li>
    </ul>

	<div class="panel" id="settings">
		<h2>Settings</h2>
		<form name="settingsForm">
			<label>Server</label>
			<input id="host" type="text" name="host" value="" />
			<label>User ID</label>
			<input id="uid" type="text" name="uid" value=""/>
			<label>Password</label>
			<input type="password" id="pw1" name="pw1" value="" />
			<label>Confirm</label>
			<input type="password" id="pw2" name="pw2" value="" />
		</form>
		<a class="button_inline" onclick="saveSettings()" target="_debug_donothing">Update</a>
	</div>

   
  </body>
</html>